#!/bin/bash

set -e  # Exit on any error

echo "========================================="
echo "Rolling Update Management Script"
echo "========================================="

# Check if cluster is running
if ! kubectl cluster-info &> /dev/null; then
    echo "ERROR: Kubernetes cluster is not running. Please run kurbeScript first."
    exit 1
fi

echo "✓ Kubernetes cluster is running"

echo ""
echo "========================================="
echo "Step 1: Pre-Update Status Check"
echo "========================================="

echo "Current deployment status:"
kubectl get deployment django-messaging-blue

echo ""
echo "Current image version:"
kubectl get deployment django-messaging-blue -o jsonpath='{.spec.template.spec.containers[0].image}'

echo ""
echo "Current pods:"
kubectl get pods -l app=django-messaging,version=blue

echo ""
echo "========================================="
echo "Step 2: Apply Updated Deployment"
echo "========================================="

# Apply the updated deployment (blue_deployment.yaml now uses version 2.0)
echo "Applying updated blue deployment (version 2.0)..."
kubectl apply -f blue_deployment.yaml

echo ""
echo "Deployment update initiated!"

echo ""
echo "========================================="
echo "Step 3: Monitor Rolling Update Progress"
echo "========================================="

# Monitor rollout status
echo "Monitoring rollout status..."
kubectl rollout status deployment/django-messaging-blue --timeout=300s

echo ""
echo "Rollout history:"
kubectl rollout history deployment/django-messaging-blue

echo ""
echo "========================================="
echo "Step 4: Continuous Downtime Testing"
echo "========================================="

# Start continuous testing in background
echo "Starting continuous health check testing..."

# Get pod name for port forwarding
POD_NAME=$(kubectl get pods -l app=django-messaging,version=blue -o jsonpath='{.items[0].metadata.name}')

if [ -z "$POD_NAME" ]; then
    echo "ERROR: No pods found for blue deployment"
    exit 1
fi

echo "Testing with pod: $POD_NAME"

# Port forward in background
echo "Setting up port forwarding..."
kubectl port-forward pod/$POD_NAME 8081:8000 &
PORT_FORWARD_PID=$!

# Wait for port forwarding to be ready
sleep 5

echo "✓ Port forwarding established on localhost:8081"

# Start continuous testing
echo ""
echo "Starting continuous health checks (every 2 seconds for 60 seconds)..."

TOTAL_REQUESTS=0
SUCCESSFUL_REQUESTS=0
FAILED_REQUESTS=0
START_TIME=$(date +%s)

# Test for 60 seconds
for i in {1..30}; do
    CURRENT_TIME=$(date +%s)
    ELAPSED=$((CURRENT_TIME - START_TIME))
    
    echo "[$ELAPSED seconds] Health check #$i..."
    
    # Make HTTP request
    if curl -f -s http://localhost:8081/api/health/ > /dev/null 2>&1; then
        SUCCESSFUL_REQUESTS=$((SUCCESSFUL_REQUESTS + 1))
        echo "✓ Health check $i: SUCCESS"
    else
        FAILED_REQUESTS=$((FAILED_REQUESTS + 1))
        echo "⚠ Health check $i: FAILED"
    fi
    
    TOTAL_REQUESTS=$((TOTAL_REQUESTS + 1))
    
    # Wait 2 seconds before next check
    sleep 2
done

END_TIME=$(date +%s)
TOTAL_TIME=$((END_TIME - START_TIME))

echo ""
echo "========================================="
echo "Downtime Test Results"
echo "========================================="
echo "Test duration: $TOTAL_TIME seconds"
echo "Total requests: $TOTAL_REQUESTS"
echo "Successful requests: $SUCCESSFUL_REQUESTS"
echo "Failed requests: $FAILED_REQUESTS"

if [ $FAILED_REQUESTS -eq 0 ]; then
    echo "✓ NO DOWNTIME DETECTED - Rolling update was seamless!"
else
    DOWNTIME_PERCENTAGE=$((FAILED_REQUESTS * 100 / TOTAL_REQUESTS))
    echo "⚠ DOWNTIME DETECTED: $DOWNTIME_PERCENTAGE% of requests failed"
fi

echo ""
echo "========================================="
echo "Step 5: Post-Update Verification"
echo "========================================="

echo "Updated deployment status:"
kubectl get deployment django-messaging-blue

echo ""
echo "Updated image version:"
kubectl get deployment django-messaging-blue -o jsonpath='{.spec.template.spec.containers[0].image}'

echo ""
echo "Updated pods:"
kubectl get pods -l app=django-messaging,version=blue

echo ""
echo "Testing updated version health endpoint..."
kubectl exec $POD_NAME -- curl -s http://localhost:8000/api/health/

echo ""
echo "========================================="
echo "Step 6: Rolling Update Analysis"
echo "========================================="

echo "Checking rollout status details..."
kubectl describe deployment django-messaging-blue | grep -A 10 "Events:"

echo ""
echo "Checking pod events for rolling update..."
kubectl get events --field-selector involvedObject.name=$(kubectl get pods -l app=django-messaging,version=blue -o jsonpath='{.items[0].metadata.name}') --sort-by='.lastTimestamp'

echo ""
echo "========================================="
echo "Step 7: Resource Usage During Update"
echo "========================================="

# Check if metrics-server is available
if kubectl top pods -l app=django-messaging,version=blue &> /dev/null; then
    echo "Resource usage after update:"
    kubectl top pods -l app=django-messaging,version=blue
else
    echo "Metrics server not available for resource monitoring"
fi

echo ""
echo "========================================="
echo "Step 8: Final Verification"
echo "========================================="

# Verify all pods are ready
READY_PODS=$(kubectl get pods -l app=django-messaging,version=blue -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}' | tr ' ' '\n' | grep -c "True" || echo "0")
TOTAL_PODS=$(kubectl get pods -l app=django-messaging,version=blue --no-headers | wc -l)

echo "Ready pods: $READY_PODS/$TOTAL_PODS"

if [ "$READY_PODS" -eq "$TOTAL_PODS" ] && [ "$TOTAL_PODS" -gt 0 ]; then
    echo "✓ All pods are ready and running"
else
    echo "⚠ Some pods are not ready yet"
fi

# Test the application functionality
echo ""
echo "Testing application functionality..."
echo "Sending a test message..."
RESPONSE=$(kubectl exec $POD_NAME -- curl -s -X POST -H "Content-Type: application/json" -d '{"content":"Test message during rolling update"}' http://localhost:8000/api/send/)
echo "Send message response: $RESPONSE"

echo ""
echo "Getting messages..."
MESSAGES=$(kubectl exec $POD_NAME -- curl -s http://localhost:8000/api/messages/ | head -c 200)
echo "Messages response: $MESSAGES..."

echo ""
echo "========================================="
echo "Rolling Update Summary"
echo "========================================="
echo "✓ Rolling update from version 1.0 to 2.0 completed"
echo "✓ Update duration: $TOTAL_TIME seconds"
echo "✓ Availability: $(( (SUCCESSFUL_REQUESTS * 100) / TOTAL_REQUESTS ))%"
echo "✓ Current image: $(kubectl get deployment django-messaging-blue -o jsonpath='{.spec.template.spec.containers[0].image}')"
echo "✓ Running pods: $READY_PODS/$TOTAL_PODS"

if [ $FAILED_REQUESTS -eq 0 ]; then
    echo "✓ ZERO DOWNTIME achieved!"
else
    echo "⚠ Minor downtime occurred during rolling update"
fi

echo ""
echo "========================================="
echo "Rolling Update Completed!"
echo "========================================="

# Clean up
echo "Cleaning up port forwarding..."
kill $PORT_FORWARD_PID 2>/dev/null || true

echo "✓ Port forwarding stopped"
