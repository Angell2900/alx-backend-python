#!/bin/bash

# Blue-Green Deployment Script
# Task 4: Implement Blue-Green Deployment Strategy

set -e

echo "ğŸš€ Starting Blue-Green Deployment Strategy..."

# Function to check pod status
check_pods() {
    echo "ğŸ” Checking pod status..."
    kubectl get pods -l app=django-messaging
    echo "ğŸ“‹ Getting deployment status..."
    kubectl get deployments -l app=django-messaging
}

# Function to check logs
check_logs() {
    local version=$1
    echo "ğŸ“œ Checking logs for $version version..."
    kubectl logs -l app=django-messaging,version=$version --tail=20
}

# Deploy Blue version (current production version)
echo "ğŸ”µ Deploying Blue version..."
kubectl apply -f blue_deployment.yaml

echo "â³ Waiting for blue deployment to be ready..."
kubectl rollout status deployment/django-messaging-app-blue --timeout=300s

# Deploy Green version (new version)
echo "ğŸŸ¢ Deploying Green version..."
kubectl apply -f green_deployment.yaml

echo "â³ Waiting for green deployment to be ready..."
kubectl rollout status deployment/django-messaging-app-green --timeout=300s

# Check both deployments are running
echo "ğŸ“Š Checking both deployments..."
check_pods

# Test green version before switching traffic
echo "ğŸ§ª Testing green version before switching traffic..."
echo "Setting service to point to green version temporarily..."

# Patch service to point to green version for testing
kubectl patch service django-messaging-service -p '{"spec":{"selector":{"version":"green"}}}'

echo "â³ Waiting for service switch to take effect..."
sleep 10

# Verify green version is working
echo "ğŸ” Verifying green version is working..."
GREEN_POD=$(kubectl get pods -l app=django-messaging,version=green -o jsonpath='{.items[0].metadata.name}')
if [ -n "$GREEN_POD" ]; then
    echo "ğŸ“œ Green version logs:"
    check_logs green
    
    # Test health check
    echo "ğŸ¥ Testing green version health..."
    kubectl exec $GREEN_POD -- curl -f http://localhost:8000/ || echo "âš ï¸  Health check failed, but continuing..."
else
    echo "âŒ No green pods found!"
    exit 1
fi

# Switch traffic back to blue (simulate rollback capability)
echo "ğŸ”„ Switching traffic back to blue version..."
kubectl patch service django-messaging-service -p '{"spec":{"selector":{"version":"blue"}}}'

echo "â³ Waiting for service switch to take effect..."
sleep 5

# Final status check
echo "ğŸ“Š Final deployment status:"
check_pods

echo "âœ… Blue-Green deployment strategy completed successfully!"
echo "ğŸ”µ Blue version is currently serving traffic"
echo "ğŸŸ¢ Green version is ready for deployment when needed"
echo ""
echo "To switch to green version, run:"
echo "kubectl patch service django-messaging-service -p '{\"spec\":{\"selector\":{\"version\":\"green\"}}}'"
echo ""
echo "To switch back to blue version, run:"
echo "kubectl patch service django-messaging-service -p '{\"spec\":{\"selector\":{\"version\":\"blue\"}}}'"
